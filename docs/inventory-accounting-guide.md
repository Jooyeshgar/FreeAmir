# راهنمای حسابداری موجودی کالا برای نرم‌افزار

## 1. اصول پایه
- هر کالا (SKU) باید **کد یکتا** داشته باشد.
- برای هر کالا دو نوع داده نگهداری می‌شود:
  1. **تعداد (Quantity)** → موجودی فیزیکی
  2. **ارزش ریالی (Value)** → موجودی حسابداری

---

## 2. بهای تمام‌شده (Cost)
بهای تمام‌شده هر کالا = **قیمت خرید + هزینه‌های جانبی (حمل، بیمه، گمرک، ترخیص، ...)**  
هزینه‌های جانبی باید **بین کالاها سرشکن (Allocate)** شوند.  
روش‌های سرشکن:
- بر اساس ارزش فاکتور (Invoice Value)
- بر اساس وزن کالا
- بر اساس تعداد کالا

---

## 3. روش حسابداری
### روش دائمی (Perpetual)
- **خرید** → موجودی کالا و میانگین بهای واحد به‌روز می‌شود.
- **فروش** → همزمان:
  1. ثبت درآمد فروش
  2. ثبت بهای تمام‌شده (COGS) و کاهش موجودی کالا

### روش میانگین موزون متحرک (Moving Average)
هر بار خرید یا اضافه شدن هزینه:
\[
میانگین = \frac{(موجودی قبلی × بهای واحد قبلی) + (خرید جدید × بهای واحد جدید)}{موجودی قبلی + خرید جدید}
\]
[راهنما](moving-weighted-average.md)
---

## 4. ساختار داده پیشنهادی
### جدول کالاها (Items)
- item_id
- name
- unit (مثلاً عدد، کیلو)
- total_quantity
- total_value
- average_unit_cost

### جدول تراکنش‌ها (Transactions)
- transaction_id
- item_id
- type (purchase, expense_allocation, sale)
- quantity (مثبت یا منفی)
- unit_cost (در خرید یا محاسبه‌شده در میانگین)
- total_cost
- date

---

## 5. مثال عددی

### خرید اول:
- کالا A: 100 عدد × 1,000,000 = 100,000,000 ریال

### خرید دوم:
- کالا A: 200 عدد × 1,200,000 = 240,000,000 ریال  
میانگین جدید:
\[
\frac{100×1,000,000 + 200×1,200,000}{300} = 1,133,333
\]

### هزینه حمل (30,000,000 ریال) پس از ورود کالا:
اضافه به موجودی → میانگین جدید:
\[
\frac{340,000,000 + 30,000,000}{300} = 1,166,667
\]

### فروش (50 عدد):
- بهای تمام‌شده فروش = 50 × 1,166,667 = 58,333,333 ریال
- موجودی باقیمانده = 250 عدد × 1,166,667 = 291,667,000 ریال

---

## 6. نکات مهم برای توسعه
- **فروش** همیشه با قیمت میانگین روز فروش ثبت شود.
- **هزینه‌های جانبی** حتی اگر بعداً مشخص شوند باید به موجودی اضافه و میانگین به‌روزرسانی شود.
- سیستم باید همزمان کاردکس **تعدادی** و کاردکس **ریالی** را نگه دارد.
- گزارش‌ها:
  - موجودی کالا (تعدادی + ریالی)
  - کاردکس هر کالا
  - سود ناخالص هر فروش
